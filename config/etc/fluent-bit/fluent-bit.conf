[SERVICE]
    Flush           5
    Daemon          Off
    Log_Level       info
    Parsers_File    parsers.conf
    # Persist file tracking offsets across restarts
    storage.path    /var/lib/fluent-bit/
    # Built-in Prometheus-style metrics endpoint for local diagnostics
    HTTP_Server     Off
    HTTP_Listen     0.0.0.0
    HTTP_Port       2020

# ==============================================================
# Input: read all systemd journal entries (logs pipeline)
# ==============================================================
[INPUT]
    Name            systemd
    Tag             edge.*
    Read_From_Tail  On
    Strip_Underscores On
    Lowercase       On
    DB              /var/lib/fluent-bit/systemd.db

# ==============================================================
# Input: node exporter metrics (metrics pipeline)
# Produces real Prometheus-compatible metrics: node_cpu_seconds_total,
# node_memory_MemTotal_bytes, node_disk_*, node_network_*, etc.
# ==============================================================
[INPUT]
    Name            node_exporter_metrics
    Tag             metrics.node
    Scrape_Interval 15
    Metrics         cpu,meminfo,diskstats,netdev,thermal_zone

# ==============================================================
# Filter: enrich logs with device metadata
# ==============================================================
[FILTER]
    Name            modify
    Match           edge.*
    Add             source edge

# Map numeric systemd priority to severity label
[FILTER]
    Name            lua
    Match           edge.*
    script          /etc/fluent-bit/severity.lua
    call            add_severity

# ==============================================================
# Output: send logs via forward protocol to Fluentd on the server
# The forward protocol preserves all record fields as structured
# key-value pairs (systemd_unit, severity, pid, comm, etc.).
# Fluent Bit's OTLP output loses these fields.
# ==============================================================
[OUTPUT]
    Name            forward
    Match           edge.*
    Host            sentry.meticulousespresso.com
    Port            24225
    Tag             edge
    # TLS for transport encryption
    tls             On
    tls.verify      On
    # Retry forever - edge devices may be offline
    Retry_Limit     False
    # Shared secret must match server-side Fluentd config
    Shared_Key      meticulous-edge-logs

# ==============================================================
# Output: send metrics via OTLP/HTTP to central OTel Collector
# node_exporter_metrics produces real OTel metrics natively.
# ==============================================================
[OUTPUT]
    Name            opentelemetry
    Match           metrics.*
    Host            sentry.meticulousespresso.com
    Port            4318
    Metrics_Uri     /v1/metrics
    Tls             On
    Tls.Verify      On
    Retry_Limit     False
    Add_Label       host.name ${HOSTNAME}
